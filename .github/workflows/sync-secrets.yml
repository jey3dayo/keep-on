name: Sync Secrets to Cloudflare

on:
  workflow_dispatch: # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã®ã¿

jobs:
  sync:
    name: Sync Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.29.3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: "package.json"

      - name: Generate Secrets JSON
        env:
          DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
        run: |
          # dotenvx ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pnpm add -g @dotenvx/dotenvx

          # Secrets JSON ã‚’ç”Ÿæˆ
          ./scripts/generate-secrets-json.sh

      - name: Sync Secrets to Cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # wrangler secret bulk ã§ä¸€æ‹¬ç™»éŒ²
          pnpm wrangler secret bulk .secrets.json

          echo "âœ… Secrets synchronized successfully"

      - name: Cleanup
        if: always()
        run: |
          # .secrets.json ã‚’å‰Šé™¤ï¼ˆæ©Ÿå¯†æƒ…å ±ã®ãŸã‚ï¼‰
          rm -f .secrets.json
          echo "âœ… Cleanup completed"

      - name: Verify Secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ğŸ“‹ Registered Secrets:"
          pnpm wrangler secret list

