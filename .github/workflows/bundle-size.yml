name: Bundle Size Check

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  check-size:
    name: Check Bundle Size
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.29.3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: "package.json"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Drizzle migrations
        run: pnpm db:generate

      - name: Build for Cloudflare
        env:
          DOTENV_PRIVATE_KEY: ${{ secrets.DOTENV_PRIVATE_KEY }}
        run: pnpm build:cf

      - name: Check bundle size
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Dry-run ã§ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
          OUTPUT=$(pnpm wrangler deploy --dry-run 2>&1 || true)
          echo "$OUTPUT"
          echo "$OUTPUT" > /tmp/bundle-size.txt

          # ã‚µã‚¤ã‚ºã‚’æŠ½å‡ºï¼ˆä¾‹: "Total Upload: 12.34 MB"ï¼‰
          SIZE=$(echo "$OUTPUT" | grep -oP 'Total Upload: \K[\d.]+(?= MB)' || echo "0")
          LIMIT=25

          echo "Bundle size: ${SIZE}MB (limit: ${LIMIT}MB)"

          # ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜ï¼ˆå¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨ï¼‰
          echo "BUNDLE_SIZE=${SIZE}" >> $GITHUB_ENV
          echo "BUNDLE_LIMIT=${LIMIT}" >> $GITHUB_ENV

          # 80%ã‚’è¶…ãˆãŸã‚‰è­¦å‘Š
          THRESHOLD=$(echo "$LIMIT * 0.8" | bc)
          if (( $(echo "$SIZE > $THRESHOLD" | bc -l) )); then
            echo "âš ï¸ Warning: Bundle size is over 80% of the limit!"
            echo "Current: ${SIZE}MB / Limit: ${LIMIT}MB"
            echo "WARNING=true" >> $GITHUB_ENV
          else
            echo "WARNING=false" >> $GITHUB_ENV
          fi

          # åˆ¶é™ã‚’è¶…ãˆãŸã‚‰ã‚¨ãƒ©ãƒ¼
          if (( $(echo "$SIZE > $LIMIT" | bc -l) )); then
            echo "âŒ Error: Bundle size exceeds the limit!"
            exit 1
          fi

          echo "âœ… Bundle size is within the limit"

      - name: Comment bundle size on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const size = process.env.BUNDLE_SIZE || 'unknown';
            const limit = process.env.BUNDLE_LIMIT || '25';
            const warning = process.env.WARNING === 'true';

            const percentage = ((parseFloat(size) / parseFloat(limit)) * 100).toFixed(1);
            const statusEmoji = warning ? 'âš ï¸' : 'âœ…';
            const statusText = warning ? 'Warning: Approaching limit!' : 'Size is healthy';

            const body = `## ðŸ“¦ Bundle Size Report

            **Size:** ${size} MB (gzipped)
            **Limit:** ${limit} MB
            **Usage:** ${percentage}%

            ${statusEmoji} ${statusText}`;

            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸ“¦ Bundle Size Report')
            );

            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: body
              });
            }

      - name: Record bundle size history
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          SIZE="${{ env.BUNDLE_SIZE }}"
          DATE=$(date +%Y-%m-%d)

          # å±¥æ­´ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p .bundle-history

          # ã‚µã‚¤ã‚ºã‚’è¨˜éŒ²
          echo "${DATE} ${SIZE}MB ${{ github.sha }}" >> .bundle-history/history.txt

          echo "ðŸ“Š Bundle size recorded: ${SIZE}MB"
