name: Cleanup PR Preview

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    name: Cleanup Preview
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.29.3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: "package.json"

      - name: Delete Preview Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          WORKER_NAME="keep-on-pr-${PR_NUMBER}"

          echo "Deleting preview worker: ${WORKER_NAME}"

          # Delete the worker
          pnpm wrangler delete --name "${WORKER_NAME}" --force || echo "Worker may not exist or already deleted"

          echo "‚úÖ Preview cleanup completed"

      - name: Comment Cleanup Status
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            const body = `## üóëÔ∏è Preview Cleanup

            Preview deployment for PR #${prNumber} has been deleted.

            Worker: \`keep-on-pr-${prNumber}\``;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

