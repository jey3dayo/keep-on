# ========================================
# グローバル設定
# ========================================

[env]
_.file = [".env"]
_.path = ["./node_modules/.bin"]

# Markdown lint/format用の変数
MD_GLOB = "**/*.md"
MD_EXCLUDE_NODE_MODULES = "#**/node_modules/**"
MD_EXCLUDE_WORKTREES = "#**/.worktrees/**"

# ========================================
# ツール
# ========================================

[tools]
node = "24.13.0"
pnpm = "10.28.0"
taplo = "0.10.0"
"pipx:yamllint" = "latest"

# ========================================
# コマンド（実処理タスク）
# ========================================

[tasks.format]
description = "Ultracite(Biome)でソース全体を整形 + Taplo + Markdownlint"
run = [
  "pnpm run format",
  "taplo fmt mise.toml",
  "pnpm markdownlint-cli2 '${MD_GLOB}' ${MD_EXCLUDE_NODE_MODULES} ${MD_EXCLUDE_WORKTREES} --fix",
]

[tasks."lint:types"]
description = "TypeScriptの型チェックのみ"
run = "pnpm tsc --noEmit"

[tasks."lint:biome"]
description = "Ultracite(Biome)のチェックのみ"
run = "pnpm run lint"

[tasks."lint:md"]
description = "Markdownのチェック"
run = "pnpm markdownlint-cli2 '${MD_GLOB}' ${MD_EXCLUDE_NODE_MODULES} ${MD_EXCLUDE_WORKTREES}"

[tasks."lint:yaml"]
description = "YAMLのチェック"
run = "yamllint -c .yamllint .github/"

# ========================================
# エイリアス（まとめ実行）
# ========================================

[tasks.lint]
description = "型チェック + Biome + Markdown + YAML"
depends = ["lint:types", "lint:biome", "lint:md", "lint:yaml"]

[tasks.check]
description = "ローカル確認（format + lint）"
depends = ["format", "lint"]

[tasks."check:quick"]
description = "クイックチェック（型 + Biome）"
depends = ["lint:types", "lint:biome"]

[tasks.ci]
description = "CI相当のチェック（format + 型チェック + Markdown + YAML + DBML生成）"
depends = ["format", "lint:types", "lint:md", "lint:yaml", "db:docs:generate"]

# ========================================
# デプロイ関連
# ========================================

[tasks.deploy]
description = "Cloudflare Workers にデプロイ"
run = "pnpm wrangler deploy"

[tasks."deploy:preview"]
description = "ローカルでCloudflare環境をプレビュー"
run = "pnpm preview"

[tasks."cf:clerk:sync"]
description = "ClerkキーをCloudflareへ再投入しビルド+デプロイ"
run = [
  "DOTENVX_PRIVATE_KEY=$(rg -N '^DOTENV_PRIVATE_KEY=' .env.keys | cut -d= -f2-) dotenvx run -- pnpm cf:build",
  "DOTENVX_PRIVATE_KEY=$(rg -N '^DOTENV_PRIVATE_KEY=' .env.keys | cut -d= -f2-) dotenvx run -- sh -lc 'printf \"%s\\n\" \"$CLERK_SECRET_KEY\" | wrangler secret put CLERK_SECRET_KEY'",
  "DOTENVX_PRIVATE_KEY=$(rg -N '^DOTENV_PRIVATE_KEY=' .env.keys | cut -d= -f2-) dotenvx run -- sh -lc 'wrangler deploy --var NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=\"$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY\" --keep-vars'",
]

# ========================================
# データベースドキュメント
# ========================================

[tasks."db:docs"]
description = "DBMLを生成してdbdocsにデプロイ"
run = ["pnpm db:docs:generate", "pnpm db:docs:push"]

[tasks."db:docs:generate"]
description = "DrizzleスキーマからDBMLを生成"
run = "pnpm db:docs:generate"
